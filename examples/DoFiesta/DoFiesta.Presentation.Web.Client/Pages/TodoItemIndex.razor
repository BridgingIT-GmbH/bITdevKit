@page "/todos"
@inject IStringLocalizer<Global> localizer
@inject IApiClient ApiClient
@inject ISnackbar Snackbar

<PageTitle>DoFiesta - Items</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (enums == null || items == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="d-flex gap-4 align-center pa-4" Elevation="0" Outlined>
                    <MudTextField @bind-Value="newTodoTitle" Immediate="false"
                                  Label="New Todo" Variant="Variant.Outlined"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add"
                                  OnAdornmentClick="() => _ = AddNewTodo()" />
                    @* OnKeyDown="@(e => { if (e.Key == "Enter") { _ = AddNewTodo(); } })" *@
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudTable Items="@items" Hover="true" Dense="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Title</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Priority</MudTh>
                        <MudTh>Due Date</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="todoItem">
                        <MudTd DataLabel="Title">
                            <MudTooltip Text="@todoItem.Description">
                                <MudTextField @bind-Value="todoItem.Title"
                                              Immediate="true"
                                              OnBlur="@(() => UpdateTodo(todoItem))" />
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            @* <MudTooltip Text="@enums.TodoStatuses.FirstOrDefault(e => e.Id == todoItem.Status).Description"> *@
                            <MudSelect Value="todoItem.Status" T="int"
                                       ValueChanged="async value => { todoItem.Status = value; await UpdateTodo(todoItem); }">
                                @foreach (var status in enums.TodoStatuses.Where(e => e.Enabled))
                                {
                                    <MudSelectItem Value="@status.Id">@status.Value</MudSelectItem>
                                }
                            </MudSelect>
                            @* </MudTooltip> *@
                        </MudTd>
                        <MudTd DataLabel="Priority">
                            @* <MudTooltip Text="@enums.TodoPriorities.FirstOrDefault(e => e.Id == todoItem.Priority).Description"> *@
                            <MudSelect Value="todoItem.Priority" T="int"
                                       ValueChanged="async value => { todoItem.Priority = value; await UpdateTodo(todoItem); }">
                                @foreach (var priority in enums.TodoPriorities.Where(e => e.Enabled))
                                {
                                    <MudSelectItem Value="@priority.Id">@priority.Value</MudSelectItem>
                                }
                            </MudSelect>
                            @* </MudTooltip> *@
                        </MudTd>
                        <MudTd DataLabel="Due Date">
                            <MudDatePicker Date="todoItem.DueDate"
                                           DateChanged="async date => { todoItem.DueDate = date; await UpdateTodo(todoItem); }"
                                           DateFormat="yyyy-MM-dd" Editable="true" Placeholder="Select Date" />
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error" Size="Size.Small"
                                           OnClick="@(() => DeleteTodo(todoItem))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="d-flex gap-4 align-center pa-4" Elevation="0" Outlined>
                    <MudTextField @bind-Value="filterTitle"
                                  Immediate="false" Label="Title"
                                  Variant="Variant.Outlined" Clearable="true"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                                  OnAdornmentClick="() => _ = LoadItems()"
                                  Class="flex-grow-0" Style="min-width: 300px;" />

                    <MudDivider Vertical="true" FlexItem="true" />

                    <MudChipSet T="int" SelectionMode="SelectionMode.ToggleSelection"
                                CheckMark SelectedValueChanged="OnStatusChipChanged">
                        @foreach (var status in enums.TodoStatuses.Where(e => e.Enabled))
                        {
                            <MudTooltip Text="@status.Description">
                                <MudChip T="int" Value="@status.Id">@status.Value</MudChip>
                            </MudTooltip>
                        }
                    </MudChipSet>

                    <MudIconButton Icon="@Icons.Material.Filled.Search"
                                   Color="Color.Default"
                                   OnClick="() => _ = LoadItems()" />
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private ICollection<TodoItemModel> items;
    private EnumerationModel enums;
    private string newTodoTitle;
    private int? filterStatusId;
    private string filterTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadEnumerations();
        await LoadItems();
    }

    private async Task LoadEnumerations()
    {
        try
        {
            var response = await ApiClient.Enumeration_GetAsync();
            enums = response.Result;
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading enumerations: {ex.Message}", Severity.Error);
            items = new List<TodoItemModel>();
        }
    }

    private async Task LoadItems()
    {
        try
        {
            var filter = new FilterModel();
            filter.Filters = new List<FilterCriteria>();

            if (filterStatusId.HasValue)
            {
                filter.Filters.Add(
                    new FilterCriteria
                        {
                            Field = "Status",
                            Operator = Client.FilterOperator.Equal,
                            Value = filterStatusId.Value
                        });
            }

            if (!string.IsNullOrWhiteSpace(filterTitle))
            {
                filter.Filters.Add(
                    new FilterCriteria
                        {
                            Field = "Title",
                            Operator = Client.FilterOperator.Contains,
                            Value = filterTitle
                        });
            }

            //var response = await ApiClient.TodoItem_GetAllAsync(filter); // filtermodel is not serialized on querystring by nswag apiclient
            var response = await ApiClient.TodoItem_PostSearchAsync(filter);
            items = response.Result.ToList();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading items: {ex.Message}", Severity.Error);
            enums = new EnumerationModel();
        }
    }

    private async Task OnStatusFilterChanged(int? statusId)
    {
        filterStatusId = statusId;
        await LoadItems();
    }

    private async Task OnStatusChipChanged(int id)
    {
        filterStatusId = id;

        if (id == 0)
            filterStatusId = null;

        await LoadItems();
    }

    private async Task AddNewTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        try
        {
            var newItem = new TodoItemModel
                {
                    Title = newTodoTitle,
                    Status = enums.TodoStatuses.First().Id,
                    Priority = enums.TodoPriorities.First().Id
                };
            newTodoTitle = string.Empty;
            items.Add(newItem);

            await ApiClient.TodoItem_PostAsync(newItem);

            Snackbar.Add("Added successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error adding todo: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateTodo(TodoItemModel item)
    {
        try
        {
            Console.WriteLine($"Updating todo: {item.Id}");
            await ApiClient.TodoItem_PutAsync(item.Id, item);

            Snackbar.Add("Updated successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error updating todo: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteTodo(TodoItemModel item)
    {
        try
        {
            items.Remove(items.FirstOrDefault(e => e.Id == item.Id));
            await ApiClient.TodoItem_DeleteByNameAsync(item.Id);

            Snackbar.Add("Deleted successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error deleting todo: {ex.Message}", Severity.Error);
        }
    }
}