@page "/todos"
@inject IStringLocalizer<Global> localizer
@inject IApiClient ApiClient
@inject ISnackbar Snackbar

<PageTitle>DoFiesta - Items</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (enums == null || items == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="10">
                <MudPaper Class="d-flex gap-2 align-center py-2 px-4" Elevation="0" Outlined>
                    <MudTextField @bind-Value="newTodoTitle" Immediate="false"
                                  Label="New Todo" Variant="Variant.Text" Margin="Margin.Dense"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add"
                                  OnAdornmentClick="() => _ = AddNewTodo()" />
                    @* OnKeyDown="@(e => { if (e.Key == "Enter") { _ = AddNewTodo(); } })" *@
                </MudPaper>
            </MudItem>

            <MudItem xs="2">
                <MudTooltip Text="Complete all items which are InProgress">
                    <MudIconButton Icon="@Icons.Material.Filled.Checklist"
                                   Color="Color.Success" Size="Size.Large"
                                   OnClick="@(() => CompleteAll())" />
                </MudTooltip>
            </MudItem>

            <MudItem xs="12">
                <MudTable Items="@items" Hover="true" Dense="true" Striped="false" Loading="@loading" LoadingProgressColor="Color.Info">
                    <ToolBarContent>
                            <MudChipSet T="int" SelectionMode="SelectionMode.ToggleSelection"
                                        Color="Color.Primary" CheckMark
                                        SelectedValueChanged="OnStatusChipChanged">
                                @foreach (var e in enums.TodoStatuses.Where(e => e.Enabled))
                                {
                                    <MudTooltip Text="@e.Description">
                                        <MudChip T="int" Value="@e.Id">@e.Value</MudChip>
                                    </MudTooltip>
                                }
                            </MudChipSet>

                            <MudDivider Vertical="true" FlexItem="true" />

                            <MudChipSet T="int" SelectionMode="SelectionMode.ToggleSelection"
                                        Color="Color.Secondary" CheckMark
                                        SelectedValueChanged="OnPriorityChipChanged">
                                @foreach (var e in enums.TodoPriorities.Where(e => e.Enabled))
                                {
                                    <MudTooltip Text="@e.Description">
                                        <MudChip T="int" Value="@e.Id">@e.Value</MudChip>
                                    </MudTooltip>
                                }
                            </MudChipSet>

                            <MudSpacer />

                            <MudTextField @bind-Value="filterTitle"
                                          Immediate="false"
                                          Label="Title"
                                          Variant="Variant.Text"
                                          Margin="Margin.Dense"
                                          Clearable="true"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          OnAdornmentClick="() => _ = LoadItems()"
                                          Style="width: 300px;" />
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh></MudTh>
                        <MudTh>Title</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Priority</MudTh>
                        <MudTh>Due</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="todoItem">
                        <MudTd>
                            @{
                                var (icon, color) = GetStatusIcon(todoItem.Status);
                                <MudIcon Icon="@icon" Color="@color" />
                            }
                        </MudTd>
                        <MudTd DataLabel="Title">
                            <MudTooltip Text="@todoItem.Description">
                                <MudTextField @bind-Value="todoItem.Title" Variant="Variant.Text" Margin="Margin.Dense"
                                              Immediate="true" Class="flex-grow-1" Style="min-width: 300px;"
                                              OnBlur="@(() => UpdateTodo(todoItem))" />
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            @* <MudTooltip Text="@enums.TodoStatuses.FirstOrDefault(e => e.Id == todoItem.Status).Description"> *@
                            <MudSelect Value="todoItem.Status" T="int"
                                       ValueChanged="async value => { todoItem.Status = value; await UpdateTodo(todoItem); }">
                                @foreach (var status in enums.TodoStatuses.Where(e => e.Enabled))
                                {
                                    <MudSelectItem Value="@status.Id">@status.Value</MudSelectItem>
                                }
                            </MudSelect>
                            @* </MudTooltip> *@
                        </MudTd>
                        <MudTd DataLabel="Priority">
                            @* <MudTooltip Text="@enums.TodoPriorities.FirstOrDefault(e => e.Id == todoItem.Priority).Description"> *@
                            <MudSelect Value="todoItem.Priority" T="int"
                                       ValueChanged="async value => { todoItem.Priority = value; await UpdateTodo(todoItem); }">
                                @foreach (var priority in enums.TodoPriorities.Where(e => e.Enabled))
                                {
                                    <MudSelectItem Value="@priority.Id">@priority.Value</MudSelectItem>
                                }
                            </MudSelect>
                            @* </MudTooltip> *@
                        </MudTd>
                        <MudTd DataLabel="Due Date">
                            <MudDatePicker Date="todoItem.DueDate"
                                           DateChanged="async date => { todoItem.DueDate = date; await UpdateTodo(todoItem); }"
                                           DateFormat="yyyy-MM-dd" Editable="true" Placeholder="Select Date" />
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error" Size="Size.Small"
                                           OnClick="@(() => DeleteTodo(todoItem))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private bool loading;
    private ICollection<TodoItemModel> items;
    private EnumerationModel enums;
    private string newTodoTitle;
    private int? filterStatusId;
    private int? filterPriorityId;
    private string filterTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadEnumerations();
        await LoadItems();
    }

    private async Task LoadEnumerations()
    {
        try
        {
            var response = await ApiClient.Enumeration_GetAsync();
            enums = response.Result;
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading enumerations: {ex.Message}", Severity.Error);
            items = new List<TodoItemModel>();
        }
    }

    private async Task LoadItems()
    {
        try
        {
            loading = true;
            var filter = new FilterModel() { Filters = new List<FilterCriteria>(), Orderings = new List<FilterOrderCriteria>() };

            if (filterStatusId.HasValue)
            {
                filter.Filters.Add(
                    new FilterCriteria
                        {
                            Field = "Status",
                            Operator = Client.FilterOperator.Equal,
                            Value = filterStatusId.Value
                        });
            }

            if (filterPriorityId.HasValue)
            {
                filter.Filters.Add(
                    new FilterCriteria
                        {
                            Field = "Priority",
                            Operator = Client.FilterOperator.GreaterThanOrEqual,
                            Value = filterPriorityId.Value
                        });
            }

            if (!string.IsNullOrWhiteSpace(filterTitle))
            {
                filter.Filters.Add(
                    new FilterCriteria
                        {
                            Field = "Title",
                            Operator = Client.FilterOperator.Contains,
                            Value = filterTitle
                        });
            }

            filter.Orderings.Add(new FilterOrderCriteria
                {
                    Field = "DueDate",
                    Direction = Client.OrderDirection.Descending
                });

            // filter.Filters.Add(
            //     new FilterCriteria
            //         {
            //             CustomType = FilterCustomType.NamedSpecification,
            //             SpecificationName = "TodoItemIsNotDeleted",
            //         });

            //var response = await ApiClient.TodoItem_GetAllAsync(filter); // filtermodel is not serialized on querystring by nswag apiclient
            var response = await ApiClient.TodoItem_PostSearchAsync(filter);
            items = response.Result.ToList();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading items: {ex.Message}", Severity.Error);
            enums = new EnumerationModel();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OnStatusFilterChanged(int? statusId)
    {
        filterStatusId = statusId;
        await LoadItems();
    }

    private async Task OnStatusChipChanged(int id)
    {
        filterStatusId = id;

        if (id == 0)
            filterStatusId = null;

        await LoadItems();
    }

    private async Task OnPriorityChipChanged(int id)
    {
        filterPriorityId = id;

        if (id == 0)
            filterPriorityId = null;

        await LoadItems();
    }

    private async Task AddNewTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        try
        {
            loading = true;
            var newItem = new TodoItemModel
                {
                    Title = newTodoTitle,
                    Status = enums.TodoStatuses.First().Id,
                    Priority = enums.TodoPriorities.First().Id
                };
            newTodoTitle = string.Empty;
            items.Add(newItem);

            await ApiClient.TodoItem_PostAsync(newItem);

            Snackbar.Add("Added successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error adding todo: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task UpdateTodo(TodoItemModel item)
    {
        try
        {
            loading = true;
            Console.WriteLine($"Updating todo: {item.Id}");
            await ApiClient.TodoItem_PutAsync(item.Id, item);

            Snackbar.Add("Updated successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error updating todo: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CompleteAll()
    {
        try
        {
            loading = true;
            Console.WriteLine($"Completing all");
            await ApiClient.TodoItem_CompleteAllAsync();

            Snackbar.Add("Completed successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error completing todos: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task DeleteTodo(TodoItemModel item)
    {
        try
        {
            loading = true;
            items.Remove(items.FirstOrDefault(e => e.Id == item.Id));
            await ApiClient.TodoItem_DeleteByNameAsync(item.Id);

            Snackbar.Add("Deleted successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error deleting todo: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private (string icon, Color color) GetStatusIcon(int statusId)
    {
        return statusId switch
        {
            1 => (Icons.Material.Filled.FiberNew, Color.Info),        // New
            2 => (Icons.Material.Filled.RunCircle, Color.Warning),    // InProgress
            3 => (Icons.Material.Filled.CheckCircle, Color.Success),  // Completed
            _ => (Icons.Material.Filled.Circle, Color.Default)        // Default
        };
    }
}