@page "/todos"
@inject IStringLocalizer<Global> localizer
@inject IApiClient ApiClient
@inject ISnackbar Snackbar

<PageTitle>Todo Items</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (enums == null || items == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="pa-4">
                    <MudTextField @bind-Value="newTodoTitle" Immediate="false"
                    Label="New Todo" Variant="Variant.Outlined"
                    Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add"
                    OnAdornmentClick="() => _ = AddNewTodo()" />
                    @* OnKeyDown="@(e => { if (e.Key == "Enter") { _ = AddNewTodo(); } })" *@
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudTable Items="@items" Hover="true" Dense="true" Striped="true">
                    @* <HeaderContent>
                        <MudTh>Title</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Priority</MudTh>
                        <MudTh>Due Date</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent> *@
                    <RowTemplate Context="todoItem">
                        <MudTd DataLabel="Title">
                            <MudTextField @bind-Value="todoItem.Title"
                                Immediate="true"
                                OnBlur="@(() => UpdateTodo(todoItem))" />
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudSelect @bind-Value="todoItem.Status"
                                Immediate="true"
                                OnBlur="@(() => UpdateTodo(todoItem))">
                                    @foreach (var status in enums.TodoStatuses)
                                    {
                                        <MudSelectItem Value="@status.Id">@status.Value</MudSelectItem>
                                    }
                            </MudSelect>
                        </MudTd>
                        <MudTd DataLabel="Priority">
                            <MudSelect @bind-Value="todoItem.Priority"
                            Immediate="true"
                            OnBlur="@(() => UpdateTodo(todoItem))">
                                @foreach (var priority in enums.TodoPriorities)
                                {
                                    <MudSelectItem Value="@priority.Id">@priority.Value</MudSelectItem>
                                }
                            </MudSelect>
                        </MudTd>
                        <MudTd DataLabel="Due Date">
                            <MudDatePicker @bind-Date="todoItem.DueDate"
                                DateFormat="yyyy-MM-dd" Editable="true"
                                Placeholder="Select Date" />
                                @* OnBlur="@(() => UpdateTodo(todoItem))" /> *@
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                Color="Color.Error" Size="Size.Small"
                                OnClick="@(() => DeleteTodo(todoItem))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-space-between align-center">
                <MudText>@items.Count() items</MudText>
                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                    <MudButton OnClick="@(() => OnStatusFilterChanged(null))"
                    Variant="@(selectedStatusId == null ? Variant.Filled : Variant.Outlined)">
                        All
                    </MudButton>
                    @foreach (var status in enums.TodoStatuses)
                    {
                        var statusId = status.Id;
                        <MudButton OnClick="@(() => OnStatusFilterChanged(statusId))"
                        Variant="@(selectedStatusId == statusId ? Variant.Filled : Variant.Outlined)">
                            @status.Value
                        </MudButton>
                    }
                </MudButtonGroup>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private ICollection<TodoItemModel> items;
    private EnumerationModel enums;
    private string newTodoTitle;
    private int? selectedStatusId;

    protected override async Task OnInitializedAsync()
    {
        await LoadEnumerations();
        await LoadItems();
    }

    private async Task LoadEnumerations()
    {
        try
        {
            var response = await ApiClient.Enumeration_GetAsync();
            enums = response.Result;
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading enumerations: {ex.Message}", Severity.Error);
            items = new List<TodoItemModel>();
        }
    }

    private async Task LoadItems()
    {
        try
        {
            var filterModel = new FilterModel
            {
                // Filters = selectedStatusId.HasValue
                //     ? new[] { new FilterCriteria { Field = "Status", Operator = FilterOperator.Equal, Value = selectedStatusId.Value } }
                //     : null
            };

            var response = await ApiClient.TodoItem_GetAllAsync(filterModel);
            items = response.Result.ToList();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error loading items: {ex.Message}", Severity.Error);
            enums = new EnumerationModel();
        }
    }

    private async Task OnStatusFilterChanged(int? statusId)
    {
        selectedStatusId = statusId;
        await LoadItems();
    }

    private async Task AddNewTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        try
        {
            var newItem = new TodoItemModel
                {
                    Title = newTodoTitle,
                    Status = enums.TodoStatuses.First().Id,
                    Priority = enums.TodoPriorities.First().Id
                };
            newTodoTitle = string.Empty;
            items.Add(newItem);

            await ApiClient.TodoItem_PostAsync(newItem);

            Snackbar.Add("Added successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error adding todo: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateTodo(TodoItemModel item)
    {
        try
        {
            Console.WriteLine($"Updating todo: {item.Id}");
            await ApiClient.TodoItem_PutAsync(item.Id, item);

            Snackbar.Add("Updated successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error updating todo: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteTodo(TodoItemModel item)
    {
        try
        {
            items.Remove(items.FirstOrDefault(e => e.Id == item.Id));
            await ApiClient.TodoItem_DeleteByNameAsync(item.Id);

            Snackbar.Add("Deleted successfully", Severity.Success);
            await LoadItems();
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"Error deleting todo: {ex.Message}", Severity.Error);
        }
    }
}